# Analisis v1 - Fallos TUI (Quorum AI)

## Metadatos
- Herramienta: codex
- Modelo: gpt-5
- Timestamp: 2026-01-18 23:19:50
- Fuente: /home/hugolma/IdeaProjects/quorum-ai/fallos-tui/{img.png,img_1.png,img_2.png}
- Entorno declarado: Go TUI (Bubble Tea + Lip Gloss + Gossip)

## Resumen ejecutivo
Se observan errores sistematicos de calculo de ancho/alto (celdas), bleeding de background, y desalineacion de capas (pseudo z-index) en componentes clave: chat, popup de comandos, overlay de shortcuts y sidebar derecho. Los sintomas apuntan a una combinacion de:
- Mezcla de calculo de ancho por bytes (len) en lugar de ancho real de runas.
- Width/Height declarados que no contemplan padding interno ni bordes.
- Uso de Place/Join con alineaciones que se desincronizan del ancho real de las lineas renderizadas.
- Espacios de relleno con background activo (color bleeding) y secuencias ANSI sin reset antes de padding.

---

## Imagen: img.png (Vista principal)

### 1) Bloques fantasma al final de InlineCode
- Ubicacion: area central de chat, en las lineas con inline code ("quorum run", "quorum analyze", "quorum plan").
- Sintoma: cada token con background rojo deja un bloque gris/blanco adicional al final. El bloque ocupa una celda despues del texto, con el mismo fondo del estilo resaltado.
- Lectura visual: el highlight parece medir 1 columna mas que el texto visible.
- Hipotesis tecnica:
  - Texto con espacio final (trailing space) antes de aplicar background.
  - Ancho calculado con len(bytes) en lugar de runewidth. Si hay ANSI, el conteo de columnas se desborda.
  - Background activo durante padding de la linea (no se hace reset antes de rellenar al ancho total).
- Impacto: ruido visual en contenido clave (comandos), reduce legibilidad y percepcion de calidad.
- Gravedad: Alta (afecta lectura continua).

### 2) Token counter con espaciado inconsistente
- Ubicacion: esquina superior derecha, "tok: 295-295".
- Sintoma: el guion parece de ancho distinto al resto, rompiendo la monoespaciacion.
- Hipotesis tecnica:
  - Renderizado con un caracter distinto al guion ASCII (p.ej. en dash o minus unicode).
  - Uso de estilos diferentes por segmentos (foreground distinto o font fallback) que cambia el ancho aparente.
- Impacto: desalineacion visual en el header.
- Gravedad: Media.

### 3) Sidebar derecho: borde derecho ausente
- Ubicacion: panel "Logs" y seccion inferior "Tokens/Resources".
- Sintoma: el borde derecho no se ve o queda fuera de pantalla. El panel parece cortado en el extremo derecho.
- Hipotesis tecnica:
  - Ancho total del layout excede el ancho del viewport y el borde queda fuera.
  - El panel derecho calcula width sin restar el grosor del borde o el padding general del contenedor padre.
  - Uso de lipgloss.JoinHorizontal con widths que suman > viewport.
- Impacto: estructura visual incompleta y confusa.
- Gravedad: Alta.

### 4) Jerarquia de fondos en mensajes
- Ubicacion: bloques de respuesta del asistente y mensajes del usuario.
- Sintoma: se ven barras oscuras de fondo solo en algunas lineas (como si el background no cubriera el width completo o se mezclara con el fondo base).
- Hipotesis tecnica:
  - Render de cada linea con ancho variable (no se normaliza a width fijo antes de unir).
  - Padding horizontal aplicado solo a algunas lineas o truncado por ancho real.
- Impacto: ruido y falta de consistencia en los bloques de mensaje.
- Gravedad: Media.

---

## Imagen: img_1.png (Popup de comandos con "/")

### 1) Seleccion con padding incorrecto
- Ubicacion: popup inferior, linea seleccionada "/clear".
- Sintoma: el highlight (barra morada) no cubre la descripcion completa y el borde derecho del popup se percibe pegado a la descripcion.
- Detalle: el texto "Clear conversation history" parece sin margen respecto al borde del panel.
- Hipotesis tecnica:
  - Width del contenedor calculado sin incluir padding interno.
  - La columna de descripciones se renderiza sin respetar el width total del popup.
  - Estilo de fondo aplicado a un sub-span con width menor al requerido.
- Impacto: el popup se ve "apretado" y desalineado.
- Gravedad: Alta.

### 2) Colisiones con layout principal al abrir el popup
- Ubicacion: zona inferior (entrada de texto + popup).
- Sintoma: al abrir la lista de comandos, el layout parece desplazarse y cortar el fondo. Se percibe una "rotura" de la terminal (segun reporte) y el input se queda con alturas anormales.
- Hipotesis tecnica:
  - El popup se inserta en el flujo normal (JoinVertical) en lugar de overlay real (Place sobre canvas).
  - Alturas no recalculadas cuando el popup esta activo, causando overflow y recorte.
- Impacto: experiencia defectuosa al usar comandos.
- Gravedad: Critica.

### 3) Borde del popup y recorte
- Ubicacion: popup inferior completo.
- Sintoma: el borde del popup parece tocar o pisar parte del contenido interno (especialmente en la esquina superior izquierda del popup).
- Hipotesis tecnica:
  - El layout interno no resta 2 columnas/filas para border y padding.
- Impacto: estilo roto, lectura dificultada.
- Gravedad: Media.

---

## Imagen: img_2.png (Overlay de Shortcuts)

### 1) Offset de background en titulos de seccion
- Ubicacion: titulos "Navigation", "Actions", "Panels", "Tools".
- Sintoma: la barra magenta de fondo no arranca justo bajo el texto; el texto comienza antes de la barra y la barra se extiende mas alla del texto.
- Hipotesis tecnica:
  - lipgloss.Place o JoinHorizontal usados con align + width incorrectos.
  - Width del titulo calculado con len y no con runewidth, generando offset.
- Impacto: inconsistencia evidente y muy visible.
- Gravedad: Alta.

### 2) Desalineacion de columnas de keybindings
- Ubicacion: listas de atajos (p.ej. "Tab -> Next agent / Complete", "Ctrl+D -> Agent diff view").
- Sintoma: el background de los labels de teclas aparece desfasado a la derecha en algunas filas, dejando el texto sobre el fondo base. En "Tools", el key badge de "Agent diff view" se ve corrido.
- Hipotesis tecnica:
  - Margenes y padding calculados por longitud incorrecta o variables de ancho no uniformes.
  - JoinHorizontal entre columnas con widths no estandarizados.
- Impacto: la lectura de atajos se vuelve irregular.
- Gravedad: Alta.

### 3) Titulo "Shortcuts" colisiona con borde superior
- Ubicacion: borde superior del panel principal.
- Sintoma: el texto "Shortcuts" parece pisado por el borde (el border atraviesa el titulo).
- Hipotesis tecnica:
  - El titulo se concatena sobre la misma linea del borde sin limpiar el area del texto.
  - Falta padding horizontal al insertar el titulo en el border.
- Impacto: error visual directo en el encabezado.
- Gravedad: Media.

### 4) Espacio vacio excesivo a la derecha
- Ubicacion: parte derecha del overlay, gran area negra vacia.
- Sintoma: el layout de columnas no distribuye el contenido de manera equilibrada. La caja principal es ancha, pero el contenido real ocupa solo la mitad izquierda.
- Hipotesis tecnica:
  - El contenedor esta a ancho fijo y las columnas no usan un layout responsive.
- Impacto: baja densidad de informacion, sensacion de composicion rota.
- Gravedad: Media.

---

## Requisitos adicionales (no solo visuales)

### 1) Token counter siempre coincide (bug funcional)
- Sintoma: entrada y salida siempre iguales ("295-295").
- Requisito: mostrar flecha arriba/abajo junto a cada numero y corregir la contabilidad.
- Implicacion tecnica:
  - Los contadores parecen usar la misma fuente o variable compartida.
  - Debe separarse input/output y actualizarse con los datos reales (posible bug en el store o en el handler de eventos).

### 2) Eliminar modo focus
- Sintoma: existe "Focus/Zen mode" (F11) en overlay de shortcuts.
- Requisito: removerlo del UI y del input handler.

### 3) Eliminar toggle stats con Ctrl+5
- Sintoma: atajo para ocultar stats.
- Requisito: remover atajo y la opcion asociada en help/shortcuts.

### 4) Al escribir "/" y abrir comandos se rompe la terminal
- Sintoma: el popup afecta el layout base, produce overflow/cortes.
- Requisito: implementar overlay real (render encima sin alterar el flujo) o recalculo de alturas correcto.

### 5) Sidebar derecho sin borde derecho
- Sintoma: el panel derecho queda abierto por el borde derecho.
- Requisito: recalcular widths sumando borde/padding y asegurar que el layout total no exceda el ancho del viewport.

---

## Diagnostico tecnico consolidado

1) Ancho real vs. bytes
- Todas las desalineaciones sugieren uso de len(string) o mediciones sin runewidth para cadenas con ANSI.
- Recomendacion: usar runewidth.StringWidth y lipgloss.Width/Height con contenidos ya renderizados.

2) Bleeding de fondo
- Las cajas de inline code muestran background en celdas extra.
- Recomendacion: trim de espacios finales antes de aplicar background o reset del estilo antes de padding.

3) Layout con Place/Join y paddings ignorados
- Popups y overlays parecen calcular width sin incluir border/padding.
- Recomendacion: medir dimensiones del contenido interno, luego sumar padding/border, o usar lipgloss.NewStyle().Padding y medir con lipgloss.Width de la salida renderizada.

4) Propagacion de WindowSize
- La falta de borde derecho y el overflow al abrir el popup sugieren que sub-modelos no reciben el width correcto.
- Recomendacion: asegurar que tea.WindowSizeMsg se propaga a cada sub-modelo y recalcular layout en cascada.

---

## Prioridad sugerida
1) Corregir overflow/rompimiento al abrir comandos (critico, bloqueo de uso).
2) Borde derecho del sidebar (layout base incorrecto).
3) Inline code con trailing block (legibilidad y calidad).
4) Overlay de shortcuts (offsets visibles, reputacional).
5) Token counter (funcional + UI).

---

## Siguientes pasos recomendados
- Instrumentar el layout con medidas (width/height) y comparar con lipgloss.Width del render.
- Probar con ventana minima y maxima para detectar overflow.
- Validar que todas las columnas usen widths constantes y que los backgrounds se apliquen solo al contenido real.
- Añadir pruebas visuales (snapshots) o logs de layout para cada overlay.

---

## Mapa a codigo (referencias concretas)

### A) Inline code con trailing blocks (img.png / img_1.png)
- Markdown rendering: `internal/tui/chat/model.go:329-334` (glamour.WithAutoStyle + WithWordWrap) y `internal/tui/chat/model.go:1906-1913` (Render + TrimSpace). El estilo de inline code proviene del tema de Glamour y puede introducir padding o espacios visibles con background.
- Sospecha tecnica: estilo de inline code + padding + trailing space en la salida renderizada (glamour) y posterior `agentMsgStyle.Render()`.

### B) Token counter siempre igual (img.png)
- Calculado en header: `internal/tui/chat/model.go:2383-2393`. Se suman tokens por agente y luego se reparten `m.totalTokens/2` a in/out.
- `m.totalTokens` se setea al final del workflow: `internal/tui/chat/model.go:1223-1224`.
- Resultado: si no hay tokens por agente, ambos lados quedan iguales por el split 50/50.

### C) Popup de comandos rompe layout (img_1.png)
- Render inline en el flujo principal: `internal/tui/chat/model.go:2327-2331` (renderInlineSuggestions dentro de renderMainContent).
- Cajas y medidas: `internal/tui/chat/model.go:2467-2583`.
- Uso de `len()` para ancho de comandos y truncado: `internal/tui/chat/model.go:2519-2542`.
- Heuristicas de ancho fijas ("-12", width-6, min 40, max 70) pueden desbordar o no incluir padding/border.

### D) Shortcuts overlay con desalineaciones (img_2.png)
- Definicion de secciones y contenido: `internal/tui/chat/shortcuts.go:31-70`.
- Render principal con calculos manuales de padding/centrado: `internal/tui/chat/shortcuts.go:133-219`.
- Box con border/padding/width fijo: `internal/tui/chat/shortcuts.go:221-231`.
- Posible origen del overlap en titulo: centrado usa `s.width` y resta `-2` sin considerar padding/border.

### E) Focus mode a eliminar
- Toggle F11: `internal/tui/chat/model.go:689-712`.
- Hint en footer: `internal/tui/chat/model.go:2649-2655`.
- Shortcuts overlay: `internal/tui/chat/shortcuts.go:44-50`.

### F) Ctrl+5 stats (eliminar toggle)
- Hint en footer: `internal/tui/chat/model.go:2652-2654`.
- Comentario/toggle en widget: `internal/tui/chat/stats_widget.go:48` y `stats_widget.go:121-129`.
- No hay binding visible a Ctrl+5, pero el UI sugiere que existe.

### G) Sidebar derecho sin borde
- Distribucion de anchos y separadores: `internal/tui/chat/model.go:1760-1851` + `internal/tui/chat/model.go:1989-2051`.
- Render del panel de logs con Width/Height fijos: `internal/tui/chat/logs.go:392-455`.
- Si la suma (explorer + separators + main + logs) supera `m.width`, el borde derecho queda fuera del viewport.

---

## Propuesta de fixes priorizados (v1)

### 1) Comandos ("/") como overlay real
- Cambiar `renderMainContent` para no insertar el dropdown en flujo; usar `overlayAtPosition` o `overlayOnBase` con coordenadas calculadas a partir de `input`.
- Calcular anchos usando `lipgloss.Width` o `runewidth.StringWidth` (no `len`).
- Ajustar `dropdownWidth` en funcion del contenido real: ancho de la columna de comandos + separadores + descripcion + padding + border.
- Incluir el header dentro del box, o medir el header con el mismo padding/border para evitar desbordes.

### 2) Token counter correcto + flechas
- Separar campos `totalTokensIn` / `totalTokensOut` en el modelo (o leerlos directamente del state/metrics en cada update).
- Eliminar el split `m.totalTokens/2`.
- UI: formato tipo `tok: ↑123 ↓456` (o `tok: in↑123 out↓456`) en `renderHeader`.

### 3) Inline code sin trailing blocks
- Cambiar el render de Glamour a un tema custom: definir estilo de inline code sin padding lateral y sin background extendido.
- Post-procesado opcional: recortar espacios finales SOLO en lineas que contienen inline code (evitar tocar code blocks).
- Verificar que el renderer no inserte espacios de relleno con background activo.

### 4) Shortcuts overlay: centrar y alinear
- Reemplazar el centrado manual por `lipgloss.Place` o `lipgloss.NewStyle().Width(innerWidth).Align(lipgloss.Center)`.
- Calcular `colWidth` usando el maximo real de (key + separadores + desc) con `lipgloss.Width`.
- Quitar offsets fijos `-2` y la regla `strings.Repeat("─", 20)`; usar ancho dinamico.
- Considerar modo 1 columna si `s.width` es pequeno.

### 5) Sidebar derecho sin borde
- Normalizar ancho total: `available = w - separators` y distribuir sidebars con clamp para que `explorer + main + logs == available`.
- Si `mainWidth` minima no cabe, reducir sidebars proporcionalmente.
- Verificar que `logsPanel.SetSize()` recibe el ancho exacto del panel final.

### 6) Eliminar focus mode
- Quitar handling F11 y el estado `focusMode`.
- Remover item de shortcuts y hint del footer.
- Eliminar logs "Focus mode enabled/disabled" y `preFocusState` si deja de usarse.

### 7) Eliminar Ctrl+5 stats toggle
- Remover hint `^5 stats`.
- Eliminar `visible` y `Toggle()` del StatsWidget si ya no se usa, o mantenerlo fijo a visible.
- Verificar que el footer de logs siempre muestra stats.

---

## Checklist QA visual (v1)

### Layout general
- Terminal 80x24, 120x40, 200x60; verificar que el borde derecho del sidebar de Logs siempre se ve.
- Sidebars on/off (solo explorer, solo logs, ambos, ninguno) sin overflow.

### Popup de comandos
- Abrir "/" con lista larga: el layout NO se rompe, el dropdown no desplaza el input.
- Seleccion alineada: background solo en la columna de comando, descripcion con padding correcto.
- Encabezado "Commands" no choca con el borde.

### Shortcuts overlay
- Titulo no colisiona con el borde superior.
- Fondos de seccion y key badges alineados; columnas consistentes.
- No hay grandes huecos laterales en resoluciones medias.

### Markdown / Inline code
- Inline code sin bloque fantasma al final (comprobar `quorum run`, `quorum analyze`).
- Code blocks siguen intactos (sin perder indent).

### Tokens y stats
- Token counter muestra `↑in` y `↓out` con valores distintos cuando corresponde.
- Footer de logs siempre visible, sin hint de Ctrl+5.

### Funcionalidad removida
- F11 no activa focus mode (no aparece en shortcuts ni en footer).
- Ctrl+5 no tiene efecto y no se documenta en UI.

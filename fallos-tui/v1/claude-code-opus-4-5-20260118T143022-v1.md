# Informe de Análisis de Errores de Renderizado TUI v1

**Proyecto:** Quorum AI
**Herramienta de análisis:** Claude Code
**Modelo:** claude-opus-4-5-20251101
**Fecha de análisis:** 2026-01-18T14:30:22Z
**Versión del informe:** v1
**Entorno técnico:** Terminal UI implementada en Go (Bubble Tea / Lip Gloss / Gossip)

---

## Resumen Ejecutivo

Se han identificado **23 defectos de renderizado** distribuidos en 3 capturas de pantalla, clasificados en 5 categorías principales:

| Categoría | Cantidad | Severidad Predominante |
|-----------|----------|------------------------|
| Bleeding de color de fondo | 7 | CRÍTICA |
| Desalineación de capas/Z-index | 5 | CRÍTICA |
| Errores de cálculo de dimensiones | 4 | ALTA |
| Inconsistencias de datos/lógica | 4 | ALTA |
| Problemas de layout/visibilidad | 3 | MEDIA |

---

## Análisis Detallado por Imagen

---

### 1. IMAGEN: `img.png` - Vista Principal Completa

**Dimensiones originales:** 3438x1346 px
**Contexto:** Estado normal de la aplicación con conversación activa

#### 1.1 Artefactos de Caracteres Fantasma (Trailing Blocks)

**Severidad:** CRÍTICA
**Localización:** Área de chat, elementos con estilo `InlineCode`
**Coordenadas aproximadas:**
- `quorum run` → (570, 337) - bloque gris visible al final
- `quorum analyze` → (665, 337) - bloque gris visible al final
- `quorum plan` → (375, 348) - bloque gris visible al final

**Descripción detallada:**
Cada cadena de texto renderizada con el estilo de código inline (`InlineCode`) presenta un bloque sólido de color gris/blanco inmediatamente después del último carácter. Este artefacto tiene las siguientes características:

- Ancho aproximado: 1-2 celdas de terminal
- Color: Coincide con el color de fondo del estilo `InlineCode` (gris claro)
- Patrón: Consistente en TODAS las instancias de código inline observadas
- El bloque NO contiene texto, es puramente un residuo de color

**Causa técnica probable:**
```go
// INCORRECTO - El estilo aplica background a espacios trailing
style := lipgloss.NewStyle().
    Background(lipgloss.Color("#4a4a4a")).
    Padding(0, 1)  // El padding derecho genera la celda extra

text := style.Render("quorum run")
// El render incluye: "quorum run " + secuencia ANSI que no cierra antes del espacio
```

**Evidencia visual:** El bloque aparece exactamente donde terminaría el padding derecho del estilo, sugiriendo que:
1. La secuencia de escape ANSI de color de fondo no se cierra antes del carácter de padding
2. O `lipgloss.Render()` está añadiendo un espacio con el estilo aplicado

---

#### 1.2 Error Crítico en Token Counter

**Severidad:** CRÍTICA
**Localización:**
- Barra superior derecha: `tok:295-295`
- Panel inferior derecho "Tokens (in-out)": `Claude 295-295`
- Panel inferior derecho "Resources": `Total: 295-295`

**Descripción detallada:**
El contador de tokens muestra valores idénticos para entrada (input) y salida (output) en TODAS las ubicaciones donde aparece. Esto es lógicamente imposible en una conversación activa porque:

- Los tokens de entrada incluyen: prompt del sistema + contexto + mensaje del usuario
- Los tokens de salida incluyen: respuesta generada por el modelo
- Estos valores NUNCA deberían coincidir en una conversación real

**Datos observados:**
| Ubicación | Valor mostrado | Valor esperado (ejemplo) |
|-----------|----------------|--------------------------|
| Header `tok:` | 295-295 | 124-471 |
| Panel Tokens | 295-295 | 124-471 |
| Total | 295-295 | Suma acumulada |

**Impacto:** El usuario no puede monitorear el consumo real de tokens, lo cual es crítico para:
- Control de costos de API
- Detección de respuestas truncadas
- Optimización de prompts

---

#### 1.3 Marco Derecho Truncado en Sidebar

**Severidad:** ALTA
**Localización:** Borde derecho de los paneles "Logs", "Tokens", "Resources"

**Descripción detallada:**
El borde derecho del marco (box border) del sidebar derecho NO es visible. La UI termina abruptamente sin el carácter de cierre vertical `│` ni las esquinas `┐` y `┘`.

**Mediciones:**
- Ancho total de ventana: ~3438px
- Ancho esperado de sidebar: ~400px
- Ancho renderizado visible: ~385px (falta ~15px / 2 caracteres)

**Causa técnica probable:**
```go
// El ancho del contenedor padre no contempla el borde
sidebarWidth := terminalWidth - mainPanelWidth
// Debería ser:
sidebarWidth := terminalWidth - mainPanelWidth - 2  // -2 para bordes
```

---

#### 1.4 Inconsistencia Visual en Separador del Token Counter

**Severidad:** BAJA
**Localización:** `tok:295-295` en header

**Descripción detallada:**
El carácter separador `-` entre los valores de tokens parece renderizarse con un ancho ligeramente diferente al resto de caracteres monoespaciados, rompiendo la alineación visual.

**Observación:** Podría ser un artefacto del escalado de la captura o un problema real de fuente.

---

#### 1.5 Panel Explorer Vacío

**Severidad:** INFORMATIVA
**Localización:** Panel izquierdo "Explorer"

**Descripción:** Muestra "0 items" con solo un punto (`.`) listado. Podría ser comportamiento esperado si no hay archivos en el directorio de trabajo, pero requiere verificación.

---

### 2. IMAGEN: `img_1.png` - Menú de Comandos Activo

**Dimensiones originales:** 3438x1346 px (escalada)
**Contexto:** Usuario ha escrito "/" activando el menú de autocompletado de comandos

#### 2.1 Desaparición del Panel Explorer

**Severidad:** CRÍTICA
**Localización:** Lado izquierdo de la pantalla

**Descripción detallada:**
Al activar el menú de comandos con `/`, el panel "Explorer" del lado izquierdo DESAPARECE completamente. La ventana principal de chat se expande para ocupar todo el espacio, pero esto rompe la consistencia de la UI.

**Comportamiento esperado:** El menú de comandos debería aparecer como overlay SIN modificar la estructura de paneles subyacente.

**Comportamiento observado:** El layout se recalcula y elimina el panel izquierdo.

---

#### 2.2 Padding Inconsistente en Highlight de Selección

**Severidad:** ALTA
**Localización:** Elemento seleccionado `/clear` en la lista de comandos

**Descripción detallada:**
El highlight púrpura/magenta que indica la selección actual muestra:

- **Lado izquierdo:** Padding correcto (~2 caracteres antes del texto)
- **Lado derecho:** El highlight se extiende inconsistentemente, a veces cortando texto

**Mediciones del highlight:**
- Comando `/clear`: highlight cubre correctamente
- Descripción "Clear conversation history": el texto está pegado al borde derecho del contenedor

---

#### 2.3 Texto de Descripción Pegado al Borde

**Severidad:** MEDIA
**Localización:** Columna de descripciones en el menú de comandos

**Descripción detallada:**
Las descripciones de cada comando (ej: "Set or show current agent", "Clear conversation history") no tienen margen derecho suficiente. En algunos casos, el texto parece colisionar con el borde del contenedor.

**Ejemplo específico:**
```
/copy        Copy last response to clipboard
             ^-- Este texto llega casi al borde del popup
```

---

#### 2.4 Artefactos Fantasma Persistentes

**Severidad:** CRÍTICA (confirmación del defecto 1.1)
**Localización:** Mismas ubicaciones que en img.png

**Descripción:** Los bloques fantasma después de `quorum run`, `quorum analyze`, y `quorum plan` siguen visibles, confirmando que es un defecto sistemático y no un artefacto de captura.

---

#### 2.5 Indicador de Comandos Adicionales

**Severidad:** INFORMATIVA
**Localización:** Parte inferior del menú: "i 10 more commands below"

**Observación:** El indicador usa color cyan para "10 more commands below", lo cual es correcto. Sin embargo, la "i" inicial podría confundirse con un comando o ícono.

---

### 3. IMAGEN: `img_2.png` - Overlay de Shortcuts/Ayuda

**Dimensiones originales:** 3438x1346 px (escalada)
**Contexto:** Modal de ayuda con atajos de teclado (activado con `?` o `F1`)

#### 3.1 DEFECTO CRÍTICO: Desfase de Capas de Color en Títulos

**Severidad:** CRÍTICA
**Localización:** Títulos de sección: "Navigation", "Actions", "Panels", "Tools"

**Descripción detallada:**
Este es el defecto más grave de composición de `Lip Gloss` observado. Los bloques de color de fondo de los títulos están **DESPLAZADOS HORIZONTALMENTE** respecto al texto que deberían resaltar.

**Mediciones del desfase:**

| Título | Desfase observado | Dirección |
|--------|-------------------|-----------|
| Navigation | ~3-4 caracteres | Fondo empieza DESPUÉS del texto |
| Actions | ~2-3 caracteres | Fondo empieza DESPUÉS del texto |
| Panels | ~3-4 caracteres | Fondo empieza DESPUÉS del texto |
| Tools | ~2-3 caracteres | Fondo empieza DESPUÉS del texto |

**Descripción visual:**
```
Texto real:     "Navigation"
Fondo renderizado:    [██████████]
                   ↑ desfase de ~3 chars
```

El texto "Navigation" comienza en la columna X, pero el bloque de color magenta oscuro comienza en la columna X+3, dejando las primeras letras sobre el fondo negro base.

**Causa técnica probable:**
```go
// Posible uso incorrecto de lipgloss.Place() o JoinHorizontal()
title := lipgloss.NewStyle().
    Background(lipgloss.Color("#5a2d5a")).
    Render("Navigation")

// El Place() podría estar aplicando offset adicional
placed := lipgloss.Place(width, height, lipgloss.Left, lipgloss.Top, title)
// Si width incluye padding/margin del contenedor padre, el texto se desplaza
```

---

#### 3.2 Desfase en Keybindings (Columna de Teclas)

**Severidad:** CRÍTICA
**Localización:** Todas las teclas con fondo resaltado (Tab, Shift+Tab, Ctrl+E, etc.)

**Descripción detallada:**
Similar al defecto 3.1, los fondos de las teclas de atajo están desalineados respecto al texto.

**Ejemplos específicos:**

| Tecla | Problema observado |
|-------|-------------------|
| `Tab` | Fondo cubre "ab" pero no "T" |
| `Shift+Tab` | Fondo desplazado ~2 chars a la derecha |
| `Ctrl+E` | Fondo comienza después de "Ctrl" |
| `Ctrl+D` | Similar desfase |
| `?/F1` | El fondo no cubre la "?" inicial |

---

#### 3.3 Bloque Fantasma en Título "Shortcuts"

**Severidad:** ALTA
**Localización:** Título principal del modal, coordenadas (~784, 218)

**Descripción detallada:**
Inmediatamente después de la palabra "Shortcuts" hay un pequeño bloque cuadrado de color rosado/magenta claro. Este es el mismo tipo de artefacto observado en los `InlineCode` del chat, confirmando que el problema es sistémico en todo el renderizado de estilos.

---

#### 3.4 Subrayado de Secciones Desalineado

**Severidad:** MEDIA
**Localización:** Línea horizontal debajo de cada título de sección

**Descripción detallada:**
La línea de subrayado (usando caracteres `─`) que aparece debajo de cada título de sección no está alineada correctamente:

- En "Navigation": el subrayado empieza correctamente pero termina antes del final del título
- En "Panels": el subrayado tiene un desfase similar al del fondo

---

#### 3.5 Colisión Título-Borde Superior

**Severidad:** BAJA
**Localización:** Borde superior del modal donde dice "Shortcuts"

**Descripción detallada:**
El título "Shortcuts" está posicionado dentro del borde superior del marco, lo cual es un patrón de diseño válido. Sin embargo, no hay suficiente padding lateral que limpie los caracteres del borde (`┌` y `─`), causando que el título "pise" ligeramente el borde en la transición.

---

## Defectos de Lógica/Funcionalidad Reportados

Estos defectos fueron reportados por el usuario y se confirman o complementan con el análisis visual:

### 4.1 Token Counter No Funciona (CONFIRMADO)

**Referencia:** Secciones 1.2
**Estado:** CONFIRMADO VISUALMENTE

El contador siempre muestra valores idénticos para entrada y salida. La recomendación del usuario es:
- Mostrar flechas direccionales (↑ para entrada, ↓ para salida) junto a cada número
- Separar claramente los valores

**Propuesta de UI:**
```
Actual:     295-295
Propuesto:  ↓124 ↑471
```

---

### 4.2 Eliminar Modo Focus

**Referencia:** Shortcut `F11 focus` visible en img.png
**Estado:** FUNCIONALIDAD A ELIMINAR

El modo focus debe ser removido de la aplicación según especificación del usuario.

---

### 4.3 Eliminar Toggle de Stats con Ctrl+5

**Referencia:** Shortcut `^5 stats` visible en img.png
**Estado:** FUNCIONALIDAD A ELIMINAR

La capacidad de ocultar stats con Ctrl+5 debe ser removida.

---

### 4.4 Menú "/" Rompe la Terminal (CONFIRMADO)

**Referencia:** Sección 2.1
**Estado:** CONFIRMADO VISUALMENTE

Al escribir "/" y activar el menú de comandos, la estructura de la terminal se rompe (desaparece el panel Explorer).

---

### 4.5 Sidebar Derecho Sin Marco Visible (CONFIRMADO)

**Referencia:** Sección 1.3
**Estado:** CONFIRMADO VISUALMENTE

El borde derecho del sidebar nunca se renderiza, está truncado.

---

## Diagnóstico Técnico Consolidado

### A. Problema Principal: Cálculo de Ancho de Strings

**Hipótesis:** El código usa `len(string)` en lugar de `runewidth.StringWidth()` para calcular anchos.

```go
// INCORRECTO
width := len(text)

// CORRECTO
import "github.com/mattn/go-runewidth"
width := runewidth.StringWidth(text)
```

**Impacto:** Secuencias ANSI, caracteres Unicode de ancho variable, y emojis causan desalineaciones.

---

### B. Problema de Secuencias de Escape No Cerradas

**Hipótesis:** Las secuencias de color de fondo no se cierran antes de espacios de padding.

```go
// El orden de operaciones importa
style := lipgloss.NewStyle().
    Background(color).
    Padding(0, 1)

// Render produce: \x1b[48;5;Xm texto \x1b[0m
//                              ↑ el espacio tiene color de fondo
```

**Solución:** Aplicar `strings.TrimRight()` ANTES del estilo de fondo, o cerrar explícitamente la secuencia.

---

### C. Problema de Propagación de WindowSizeMsg

**Hipótesis:** El mensaje `tea.WindowSizeMsg` no se propaga correctamente a todos los sub-modelos.

```go
func (m Model) Update(msg tea.Msg) (tea.Model, tea.Cmd) {
    switch msg := msg.(type) {
    case tea.WindowSizeMsg:
        m.width = msg.Width
        m.height = msg.Height
        // FALTA: propagar a componentes hijos
        m.sidebar.SetSize(sidebarWidth, msg.Height)
        m.chat.SetSize(chatWidth, msg.Height)
    }
}
```

---

### D. Problema de lipgloss.Place() y JoinHorizontal()

**Hipótesis:** Los valores de alineación en `Place()` no coinciden con el renderizado real.

```go
// El ancho calculado no incluye secuencias ANSI
content := style.Render("Navigation")
placed := lipgloss.Place(20, 1, lipgloss.Left, lipgloss.Top, content)
// Si len(content) incluye secuencias ANSI, el cálculo de posición es incorrecto
```

---

## Matriz de Priorización de Correcciones

| # | Defecto | Severidad | Esfuerzo | Prioridad |
|---|---------|-----------|----------|-----------|
| 1 | Desfase de color en overlay shortcuts | CRÍTICA | MEDIO | P0 |
| 2 | Bloques fantasma en InlineCode | CRÍTICA | BAJO | P0 |
| 3 | Token counter con valores idénticos | CRÍTICA | BAJO | P0 |
| 4 | Menú "/" rompe layout | CRÍTICA | MEDIO | P0 |
| 5 | Sidebar sin borde derecho | ALTA | BAJO | P1 |
| 6 | Desfase en keybindings | CRÍTICA | MEDIO | P1 |
| 7 | Eliminar modo Focus | ALTA | BAJO | P1 |
| 8 | Eliminar Ctrl+5 para stats | ALTA | BAJO | P1 |
| 9 | Padding en menú comandos | MEDIA | BAJO | P2 |
| 10 | Subrayado desalineado | MEDIA | BAJO | P2 |

---

## Archivos Probablemente Afectados

Basado en la naturaleza de los defectos, los archivos más probables a revisar son:

1. **Estilos globales:** `internal/tui/styles.go` o similar
2. **Componente de chat:** `internal/tui/chat.go` o `internal/tui/messages.go`
3. **Componente de overlay:** `internal/tui/help.go` o `internal/tui/shortcuts.go`
4. **Componente de sidebar:** `internal/tui/sidebar.go` o `internal/tui/panels.go`
5. **Modelo principal:** `internal/tui/model.go` o `internal/tui/app.go`
6. **Manejo de comandos:** `internal/tui/commands.go` o `internal/tui/input.go`
7. **Contador de tokens:** `internal/tui/tokens.go` o `internal/tui/stats.go`

---

## Anexo: Capturas Analizadas

| Archivo | Descripción | Defectos Identificados |
|---------|-------------|------------------------|
| `img.png` | Vista principal completa | 5 |
| `img_1.png` | Menú de comandos activo | 5 |
| `img_2.png` | Overlay de shortcuts | 5 |

---

**Fin del informe v1**

*Generado automáticamente por Claude Code (claude-opus-4-5-20251101)*

# Analysis Refinement (Round {{.Round}})

## PRIMARY OBJECTIVE

Your goal is to create the **BEST POSSIBLE ANALYSIS** by synthesizing:
- The strengths of all participating models/agents
- The agreement points already established
- Resolution of dissonant points with concrete evidence

## CRITICAL RULES

### 1. COMPLETE and Autonomous Analysis (MANDATORY)

**Your V{{.Round}} must be a COMPLETE and INDEPENDENT analysis.**

- **NEVER** reference previous versions (V1, V2, V3...)
- **NEVER** mention "in the previous analysis", "as stated before", etc.
- **NEVER** write "in addition to the above" or "keeping previous points"
- Your analysis must be readable WITHOUT knowing any previous version
- Each statement must be complete with its context and evidence

### 2. Synthesis of Strengths

**Integrate the best of each perspective without explicitly mentioning them.**

- Gather valuable insights from other models/agents
- Incorporate observations that complement your analysis
- If another agent identified something you didn't see, include it as a natural part of your analysis
- The result must be superior to any individual analysis

### 3. Divergence Resolution

**Progressively reduce points of disagreement.**

- Ground each point with specific code evidence (file:line)
- If there are contradictory positions, investigate the code to determine which is correct
- If you cannot verify something, DO NOT include it
- Eliminate hallucinations and unfounded statements

**FORBIDDEN to write:**
- "As I mentioned in V{{.PreviousRound}}..."
- "In addition to the above..."
- "The arbiter pointed out that..."
- "Other agents indicated..."
- "In the previous round..."

**CORRECT:**
- Write each point as if it were the first time you're presenting it
- Integrate improvements naturally without external references
- Each section must be self-contained and complete

## Original Request
{{.Prompt}}

## Project Context
{{.Context}}

## Analysis V{{.PreviousRound}} to Review

Your analysis from the previous round (use as base, but generate a complete document):
{{.PreviousAnalysis}}

{{if .HasArbiterEvaluation}}
## Arbiter Evaluation

An impartial arbiter evaluated the consensus among all agents. Current score: **{{printf "%.0f" .ConsensusScore}}%** (threshold: {{printf "%.0f" .Threshold}}%)

### Established Agreements (PRESERVE THESE)
The following points have consensus among all agents. You MUST keep them in your refined analysis:
{{if .Agreements}}
{{range .Agreements}}- {{.}}
{{end}}
{{else}}
No established agreements yet.
{{end}}

### Divergences to Resolve
The arbiter identified these divergences that need resolution:
{{if .Divergences}}
{{range .Divergences}}
#### {{.Category}}
- Your position: {{.YourPosition}}
- Other agents: {{.OtherPositions}}
- Arbiter guidance: {{.Guidance}}
{{end}}
{{else}}
No specific divergences identified.
{{end}}

### Missing Perspectives
{{if .MissingPerspectives}}
These aspects need to be addressed:
{{range .MissingPerspectives}}- {{.}}
{{end}}
{{else}}
No missing perspectives identified.
{{end}}

## Your Task

Generate V{{.Round}} as the **BEST POSSIBLE ANALYSIS** - complete, definitive, and autonomous:

1. **SYNTHESIZE strengths** - Integrate the best insights from all agents into your analysis
2. **PRESERVE agreements** - Include consensus points as your own statements (without mentioning they are consensus)
3. **RESOLVE divergences** - Investigate the code and take a grounded position
4. **FILL gaps** - Add missing perspectives, investigating the code
5. **VALIDATE new hypotheses** - Cross-agent feedback will spark considerations you didn't have before. Go back to the codebase and verify them with `file:line` evidence before including them — do not reason about them in the abstract
6. **ELIMINATE errors** - Don't include anything you can't verify with evidence
7. **NO REFERENCES** - NEVER mention previous versions, arbiters, or other agents

**REMEMBER**: The reader of your V{{.Round}} doesn't know that previous versions existed. Write as if this were your only and definitive analysis.
{{else}}
## Ultra-Critical Review

This is your opportunity to improve your analysis before it is compared with other agents.

### Your Task

Generate V{{.Round}} as the **BEST POSSIBLE ANALYSIS** - complete, definitive, and autonomous:

1. **Verify each statement** - Is it grounded in code with specific file:line?
2. **Question assumptions** - Did you assume something without verifying? Is there circular logic?
3. **Identify omissions** - What important aspects did you NOT cover? Investigate them now
4. **Look for counterexamples** - Is there code that contradicts your conclusions?
5. **Eliminate the unverifiable** - If you can't ground something, DO NOT include it

### Quality Criteria

Your V{{.Round}} must be a **complete, autonomous, and definitive** document:

- **NO REFERENCES** to previous versions - write as if it were your only analysis
- **Grounded** - each point with specific code evidence
- **Complete** - covers all relevant aspects
- **Specific** - fewer generalities, more concrete references
- **Clean** - no hallucinations or unverified statements

**REMEMBER**: The reader doesn't know that previous versions existed. Write as if this were your only and definitive analysis.
{{end}}

{{if .Constraints}}
## Constraints
{{range .Constraints}}- {{.}}
{{end}}
{{end}}

---

## CRITICAL: SELF-CONTAINED DOCUMENT REQUIREMENTS

Your V{{.Round}} must be a **COMPLETE, SELF-CONTAINED DOCUMENT** that serves as the **SINGLE SOURCE OF TRUTH**:

### 1. Zero External Dependencies
- **NEVER** assume the reader has access to V{{.PreviousRound}}, arbiter evaluations, or other agents' work
- **NEVER** reference previous rounds, other analyses, or external documents
- **INCLUDE ALL** context necessary to understand each finding
- Your document must be **FULLY COMPREHENSIBLE** in complete isolation

### 2. Comprehensive Content for Future Phases
Your analysis will be used directly by **planning** and **execution** phases. Include:
- **Architecture Overview**: Complete understanding of the system structure
- **Component Relationships**: How parts interact (with ASCII diagrams when they help clarify a flow)
- **Data Flows**: How information moves through the system
- **Extension Points**: Where and how the system can be extended
- **Constraints and Limitations**: Technical boundaries that must be respected
- **Risks and Mitigations**: Identified issues with proposed solutions

### 3. Visual Aids (ASCII Diagrams — When They Add Value)
Include ASCII diagrams when they help understand a flow or relationship:
- System architecture and component relationships
- Data flow between modules
- Proposed solutions or changes
- Decision trees for complex logic
- Directory structures when relevant

Example:
```
+------------------+     +------------------+
|   Component A    |---->|   Component B    |
+------------------+     +------------------+
        |                        |
        v                        v
+------------------+     +------------------+
|   Component C    |<----|   Component D    |
+------------------+     +------------------+
```

### 4. Step-by-Step Explanations
For complex findings or recommendations:
- Provide clear sequential explanations
- Use numbered steps where appropriate
- Include decision criteria with rationale
- Document trade-offs with evidence

### 5. Evidence-Rich Content
Every claim must include:
- **File path and line number**: `path/to/file.go:123`
- **Code snippets**: When they clarify the point
- **Quantitative data**: Counts, metrics when relevant

### 6. Structured for Downstream Consumption
Organize your analysis so that:
- A planner can extract actionable items without ambiguity
- An executor can understand the technical context completely
- A reviewer can verify claims against the cited evidence
- **No follow-up questions should be necessary**

---

## Output Requirements

Generate your V{{.Round}} analysis in markdown format with these characteristics:

1. **Complete document** - Must contain the entire analysis, no references to previous versions
2. **Clear structure** - Use sections that best communicate the findings
3. **Specific evidence** - Cite files and lines of code
4. **Visual diagrams** - Include ASCII diagrams when they help clarify architecture, flows, or relationships
5. **Autonomous** - Any reader must understand the analysis without seeing V{{.PreviousRound}} or ANY other document
6. **Token-budgeted completeness** - Be complete on *load-bearing* details, but do NOT exceed model output limits. Prefer density over length: fewer words, more evidence and decisions.

### OUTPUT GUIDELINES

- Be exhaustive in coverage — do not skip relevant aspects, edge cases, or risks.
  But be dense in expression: fewer words per finding, more findings.
- Prefer density over length: tables, bullet lists, `file:line` citations.
- Every sentence must carry information. Eliminate filler and verbose preambles.
- You may use multiple tool calls to write the file if needed, but every write
  must contain substantive analysis. Do NOT create placeholder content
  (headings-only outlines, "TODO", "to be written" markers).
{{if .OutputFilePath}}

Write your complete V{{.Round}} analysis to the following file:

```
{{.OutputFilePath}}
```

**IMPORTANT - File format:**
- Write ONLY the analysis content in markdown
- DO NOT add YAML frontmatter (`---` ... `---` blocks at the beginning)
- DO NOT add metadata, file headers, or system information
- DO NOT include markers like `# File:` or file comments
- Content must start directly with your analysis

Use your file writing tool to create this markdown document.
{{end}}
